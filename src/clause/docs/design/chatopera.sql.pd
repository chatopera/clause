/*==============================================================*/
/* DBMS name:      MySQL 5.0                                    */
/* Created on:     2019/8/14 12:49:45                           */
/*==============================================================*/


alter table cl_bot_sysdict
   drop primary key;

drop table if exists cl_bot_sysdict;

alter table cl_chat_msgs
   drop primary key;

drop table if exists cl_chat_msgs;

alter table cl_chat_sessions
   drop primary key;

drop table if exists cl_chat_sessions;

alter table cl_dev_vers
   drop primary key;

drop table if exists cl_dev_vers;

alter table cl_dict_words
   drop primary key;

drop table if exists cl_dict_words;

alter table cl_dicts
   drop primary key;

drop table if exists cl_dicts;

alter table cl_intent_slots
   drop primary key;

drop table if exists cl_intent_slots;

alter table cl_intent_utters
   drop primary key;

drop table if exists cl_intent_utters;

alter table cl_intents
   drop primary key;

drop table if exists cl_intents;

alter table cl_prod_vers
   drop primary key;

drop table if exists cl_prod_vers;

/*==============================================================*/
/* Table: cl_bot_sysdict                                        */
/*==============================================================*/
create table cl_bot_sysdict
(
   id                   varchar(32) not null comment 'ID',
   chatbotID            varchar(50) not null comment '聊天机器人ID',
   dict_id              varchar(32) not null comment '关联词典ID',
   createdate           timestamp not null default CURRENT_TIMESTAMP comment '创建日期'
);

alter table cl_bot_sysdict comment '引用系统词典表';

alter table cl_bot_sysdict
   add primary key (id);

alter table cl_bot_sysdict
   add unique UNQ_REF_SYSDICT (chatbotID, dict_id);

/*==============================================================*/
/* Table: cl_chat_msgs                                          */
/*==============================================================*/
create table cl_chat_msgs
(
   id                   varchar(32) not null comment 'ID',
   session_id           varchar(32) comment '会话ID',
   chatbotID            varchar(50) not null comment '聊天机器人ID',
   type                 varchar(32) not null default 'textMessage' comment '消息类型',
   textMessage          varchar(500) comment '文本消息',
   audioMessage         varchar(500) comment '语音消息',
   videoMessage         varchar(500) comment '视频消息',
   imageMessage         varchar(500) comment '图片消息',
   direction            tinyint not null default 0 comment '消息发送方向',
   sender               varchar(50) not null comment '发送者ID',
   receiver             varchar(50) not null comment '接收者ID',
   createdate           timestamp not null default CURRENT_TIMESTAMP comment '创建日期'
);

alter table cl_chat_msgs
   add primary key (id);

/*==============================================================*/
/* Table: cl_chat_sessions                                      */
/*==============================================================*/
create table cl_chat_sessions
(
   id                   varchar(32) not null comment 'ID',
   intent_id            varchar(32) comment '意图ID',
   chatbotID            varchar(32) not null comment '聊天机器人ID',
   uid                  varchar(32) not null comment '消费者ID，对话人标识',
   createdate           timestamp not null default CURRENT_TIMESTAMP comment '创建日期',
   updatedate           timestamp not null default CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP comment '更新日期',
   states               text comment '自然语言理解信息',
   resolved             tinyint not null default 0 comment '是否完成意图的槽位参数识别',
   channel              varchar(32) not null comment '对话渠道'
);

alter table cl_chat_sessions comment '对话会话管理';

alter table cl_chat_sessions
   add primary key (id);

/*==============================================================*/
/* Table: cl_dev_vers                                           */
/*==============================================================*/
create table cl_dev_vers
(
   id                   varchar(32) not null comment 'ID',
   chatbotID            varchar(50) not null comment '聊天机器人ID',
   version              varchar(10) not null comment '版本名',
   createdate           timestamp not null default CURRENT_TIMESTAMP comment '创建日期',
   modepath             varchar(300) not null comment '模型位置',
   operated             varchar(200) comment '操作员用户名',
   published            tinyint not null default 0 comment '是否已经上线'
);

alter table cl_dev_vers comment '聊天机器人调试版本';

alter table cl_dev_vers
   add primary key (id);

alter table cl_dev_vers
   add unique UNQ_DEV_VERSIONS_CHATBOTID_N_VERSION (chatbotID, version);

/*==============================================================*/
/* Table: cl_dict_words                                         */
/*==============================================================*/
create table cl_dict_words
(
   word                 varchar(100) not null comment '标准词',
   dict_id              varchar(32) not null comment '自定义字典ID',
   synonyms             varchar(1000) comment '近义词集合，多个同义词使用分号分隔',
   createdate           timestamp not null default CURRENT_TIMESTAMP comment '创建日期',
   updatedate           timestamp not null default CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP comment '上次更新日期',
   tag                  varchar(10) comment '词汇词性',
   lang                 varchar(10) comment '词汇所属语言'
);

alter table cl_dict_words comment '用户自定义字典词条';

alter table cl_dict_words
   add primary key (word, dict_id);

/*==============================================================*/
/* Table: cl_dicts                                              */
/*==============================================================*/
create table cl_dicts
(
   id                   varchar(32) not null comment '唯一标识',
   name                 varbinary(32) not null comment '名称',
   chatbotID            varchar(50) not null comment '聊天机器人ID',
   description          varchar(100) comment '描述',
   createdate           timestamp not null default CURRENT_TIMESTAMP comment '创建日期',
   updatedate           timestamp not null default CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP comment '上次更新日期',
   samples              varchar(200) comment '示例词条',
   builtin              tinyint not null default 0 comment '是否是系统词典',
   active               tinyint default 1 comment '是否启用，只针对系统词典'
);

alter table cl_dicts comment '词典';

alter table cl_dicts
   add primary key (id);

alter table cl_dicts
   add unique UNQ_CUSTOM_DICT_CHATBOTID_N_NAME (name, chatbotID);

/*==============================================================*/
/* Table: cl_intent_slots                                       */
/*==============================================================*/
create table cl_intent_slots
(
   id                   varchar(32) not null comment 'ID',
   intent_id            varchar(32) not null comment '意图ID',
   name                 varchar(32) not null comment '槽位名称',
   createdate           timestamp not null default CURRENT_TIMESTAMP comment '创建日期',
   updatedate           timestamp not null default CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP comment '更新日期',
   dict_id              varchar(32) not null comment '关联字典ID',
   requires             tinyint not null default 1 comment '是否必须',
   question             varchar(800) comment '追问'
);

alter table cl_intent_slots comment '意图的槽位';

alter table cl_intent_slots
   add primary key (id);

alter table cl_intent_slots
   add unique AK_UNQ_INTENT_SLOT_INTENTID_N_NAME (intent_id, name);

/*==============================================================*/
/* Table: cl_intent_utters                                      */
/*==============================================================*/
create table cl_intent_utters
(
   id                   varchar(32) not null comment '说法ID',
   intent_id            varchar(32) comment '意图ID',
   utterance            varchar(800) not null comment '说法',
   createdate           timestamp not null default CURRENT_TIMESTAMP comment '创建日期',
   updatedate           timestamp not null default CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP comment '更新日期'
);

alter table cl_intent_utters comment '意图的说法';

alter table cl_intent_utters
   add primary key (id);

/*==============================================================*/
/* Table: cl_intents                                            */
/*==============================================================*/
create table cl_intents
(
   id                   varchar(32) not null,
   chatbotID            varchar(50) not null comment '聊天机器人ID',
   name                 varchar(32) not null comment '名称',
   description          varchar(50) comment '意图中文名',
   createdate           timestamp not null default CURRENT_TIMESTAMP comment '创建日期',
   updatedate           timestamp not null default CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP comment '上次更新日期'
);

alter table cl_intents comment '聊天机器人意图';

alter table cl_intents
   add primary key (id);

alter table cl_intents
   add unique UNQ_INTENT_CHABOTID_N_NAME (chatbotID, name);

/*==============================================================*/
/* Table: cl_prod_vers                                          */
/*==============================================================*/
create table cl_prod_vers
(
   id                   varchar(32) not null comment 'ID',
   chatbotID            varchar(50) not null comment '聊天机器人ID',
   version              varchar(10) not null comment '版本号',
   createdate           timestamp not null comment '创建日期',
   modelpath            varchar(300) comment '模型位置',
   operated             varchar(200) comment '操作员',
   active               tinyint default 0 comment '手否在线上运行',
   notes                text comment '描述',
   latest               tinyint not null default 0 comment '是否是当前线上工作版本',
   dev_ver_id           varchar(32)
);

alter table cl_prod_vers comment '聊天机器人上线版本';

alter table cl_prod_vers
   add primary key (id);

alter table cl_prod_vers
   add unique UNQ_PROD_VERSION_CHABOTID_N_VERSION (version, chatbotID);

alter table cl_bot_sysdict add constraint FK_REF_REF_SYSDICT_DICTID foreign key (dict_id)
      references cl_dicts (id) on delete restrict on update restrict;

alter table cl_chat_msgs add constraint FK_REF_CHAT_MESSAGE_SESSIONID foreign key (session_id)
      references cl_chat_sessions (id) on delete restrict on update restrict;

alter table cl_chat_sessions add constraint FK_REF_CHAT_STATE_TACKING foreign key (intent_id)
      references cl_intents (id) on delete restrict on update restrict;

alter table cl_dict_words add constraint FK_REF_CUSTOMDICT_WORDS_DICT_ID foreign key (dict_id)
      references cl_dicts (id) on delete restrict on update restrict;

alter table cl_intent_slots add constraint FK_REF_INTENT_SLOT_DICT_ID foreign key (dict_id)
      references cl_dicts (id) on delete restrict on update restrict;

alter table cl_intent_slots add constraint FK_REF_INTENT_SLOT_INTENT_ID foreign key (intent_id)
      references cl_intents (id) on delete restrict on update restrict;

alter table cl_intent_utters add constraint FK_REF_INTENT_UTTERS_INTENT_ID foreign key (intent_id)
      references cl_intents (id) on delete restrict on update restrict;

alter table cl_prod_vers add constraint FK_REF_PROD_VERS_DEV_VERSION_ID foreign key (dev_ver_id)
      references cl_dev_vers (id) on delete restrict on update restrict;

